# --- 1. TRUST CLOUDFLARE IPS ---
set_real_ip_from 103.21.244.0/22;
set_real_ip_from 103.22.200.0/22;
set_real_ip_from 103.31.4.0/22;
set_real_ip_from 104.16.0.0/13;
set_real_ip_from 104.24.0.0/14;
set_real_ip_from 108.162.192.0/18;
set_real_ip_from 131.0.72.0/22;
set_real_ip_from 141.101.64.0/18;
set_real_ip_from 162.158.0.0/15;
set_real_ip_from 172.64.0.0/13;
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 188.114.96.0/20;
set_real_ip_from 190.93.240.0/20;
set_real_ip_from 197.234.240.0/22;
set_real_ip_from 198.41.128.0/17;

real_ip_header CF-Connecting-IP;

# --- 2. SECURITY & TLS ---
ssl_client_certificate /etc/cloudflare/ca.pem;
ssl_verify_client on;

add_header Content-Security-Policy "default-src 'self'; object-src 'none'; frame-ancestors 'self'; base-uri 'self';" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Permissions-Policy "geolocation=(), microphone=()" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# --- 3. GZIP ---
gzip on;
gzip_vary on;
gzip_min_length 1000;
gzip_proxied any;
gzip_types text/plain text/css text/xml application/xml text/javascript application/x-javascript image/svg+xml;
gzip_disable "MSIE [1-6]\.";

# --- 4. LOCATION BLOCK ---
location / {
    # 1. Route to Host proxy via Tailscale on port XXXX
    proxy_pass https://host.tail.ts.net:port;
    
    # 4. IDENTITY: Pass the true WAN IP (extracted in Section 1)
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 5. WEBSOCKETS & TIMEOUTS
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
    proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
    proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
    
    proxy_http_version 1.1;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    keepalive_timeout 86400;
    send_timeout 86400;
    
    proxy_set_header Accept-Encoding "";
    proxy_redirect off;
    proxy_buffering off;
}